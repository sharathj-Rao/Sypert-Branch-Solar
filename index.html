<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Field Polygon Tracker</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChMqsXpBm1DRafykmwl1Ouv7oOVnLNdUM"></script>
  <style>
    body {margin:0; font-family:Arial;}
    #map {height:100vh;}
    #login, #form {position:absolute; top:10px; left:10px; background:white; padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3); z-index:100;}
    #form {display:none;}
    input, button, select {margin:5px 0; width:180px;}
  </style>
</head>
<body>
  <div id="login">
    <h3>Login</h3>
    Username: <input id="username" type="text"><br>
    <button onclick="login()">Enter Map</button>
  </div>

  <div id="form">
    <h3>Update Polygon</h3>
    Status: <select id="status">
      <option>Pending</option>
      <option>In Progress</option>
      <option>Complete</option>
    </select><br>
    Notes: <input id="notes" type="text"><br>
    <button onclick="sendUpdate()">Save</button>
  </div>

  <div id="map"></div>

  <script>
    let map, currentFeature, currentId, user = "";
    const WEB_APP_URL = "https://script.google.com/a/macros/sensehawk.com/s/AKfycbw50AXD7u2z7F6tJqrjccBgxKqbNb4MPRolCClkVVHdZr5iO7cpH0pU_PS33cFrfhSrRw/exec";

    function login() {
      user = document.getElementById("username").value.trim();
      if (user) {
        document.getElementById("login").style.display = "none";
        document.getElementById("form").style.display = "block";
        initMap();
      }
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: {lat: 12.97, lng: 77.59},
        zoom: 13
      });

      // Load polygons from GeoJSON
      map.data.loadGeoJson('https://raw.githubusercontent.com/sharathj-Rao/Sypert-Branch-Solar/refs/heads/main/Blk_name.geojson');

      map.data.setStyle({
        fillColor: '#F44336',
        strokeWeight: 2,
        fillOpacity: 0.4
      });

      map.data.addListener('click', function(event) {
        currentFeature = event.feature;
        currentId = event.feature.getId() || event.feature.getProperty('id') || 'unknown';
        document.getElementById('form').style.display = 'block';
      });
    }

    function sendUpdate() {
      if (!currentId || !user) return;

      const payload = {
        id: currentId,
        status: document.getElementById("status").value,
        user: user,
        notes: document.getElementById("notes").value
      };

      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {"Content-Type": "application/json"},
        mode: "no-cors"
      });

      // Update color
      const color = payload.status === "Complete" ? "#4CAF50" :
                    payload.status === "In Progress" ? "#FF9800" : "#F44336";

      map.data.overrideStyle(currentFeature, { fillColor: color, fillOpacity: 0.6 });

      alert("Updated");
    }
  </script>
</body>
</html>